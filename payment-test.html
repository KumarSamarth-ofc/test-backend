<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Routes Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .response {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            background: #f5f5f5;
            border-left: 4px solid #667eea;
        }

        .response.success {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .response.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .response pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 13px;
            line-height: 1.5;
        }

        .token-display {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
            margin-top: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-badge.authenticated {
            background: #28a745;
            color: white;
        }

        .status-badge.not-authenticated {
            background: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí≥ Payment Routes Tester</h1>

        <!-- Configuration Section -->
        <div class="section">
            <h2>‚öôÔ∏è Configuration</h2>
            <div class="form-group">
                <label for="baseUrl">Base URL:</label>
                <input type="text" id="baseUrl" value="http://localhost:3000/api/v1" placeholder="http://localhost:3000/api/v1">
                <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                    <strong>Important:</strong> If you see "Failed to fetch" errors, serve this HTML file through a local server instead of opening it directly:
                    <br>‚Ä¢ Python: <code>python -m http.server 8000</code> then open <code>http://localhost:8000/payment-test.html</code>
                    <br>‚Ä¢ Node: <code>npx http-server -p 8000</code>
                    <br>‚Ä¢ Or use VS Code Live Server extension
                </small>
            </div>
            <button onclick="testConnection()" style="background: #28a745; margin-bottom: 15px;">Test Connection</button>
            <div id="connectionTestResponse" class="response" style="display: none;"></div>
            <div class="token-display" id="tokenDisplay">
                <strong>Token:</strong> <span id="tokenValue">Not set</span>
                <span class="status-badge not-authenticated" id="authStatus">Not Authenticated</span>
            </div>
        </div>

        <!-- Authentication Section -->
        <div class="section">
            <h2>üîê Authentication (Phone OTP)</h2>
            <div class="grid">
                <div class="form-group">
                    <label for="phoneNumber">Phone Number:</label>
                    <input type="text" id="phoneNumber" placeholder="+1234567890" value="+919876543210">
                    <small style="color: #666; font-size: 12px;">Format: +[country code][number]</small>
                </div>
                <div class="form-group">
                    <label for="userRole">Role (Optional):</label>
                    <select id="userRole" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                        <option value="">Select Role</option>
                        <option value="BRAND_OWNER">BRAND_OWNER</option>
                        <option value="INFLUENCER">INFLUENCER</option>
                        <option value="ADMIN">ADMIN</option>
                    </select>
                </div>
            </div>
            <button onclick="sendOTP()">Send OTP</button>
            <div id="sendOTPResponse" class="response" style="display: none;"></div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label for="otpToken">OTP Token:</label>
                <input type="text" id="otpToken" placeholder="Enter 4-6 digit OTP" maxlength="6">
            </div>
            <button onclick="verifyOTP()">Verify OTP & Login</button>
            <div id="verifyOTPResponse" class="response" style="display: none;"></div>
        </div>

        <!-- Get Payment Config -->
        <div class="section">
            <h2>üìã Get Payment Config</h2>
            <button onclick="getPaymentConfig()">Get Payment Config</button>
            <div id="configResponse" class="response" style="display: none;"></div>
        </div>

        <!-- Create Payment Order -->
        <div class="section">
            <h2>üí∞ Create Payment Order</h2>
            <div class="form-group">
                <label for="applicationId">Application ID:</label>
                <input type="text" id="applicationId" placeholder="application-uuid">
            </div>
            <button onclick="createPaymentOrder()">Create Payment Order</button>
            <div id="createOrderResponse" class="response" style="display: none;"></div>
        </div>

        <!-- Verify Payment -->
        <div class="section">
            <h2>‚úÖ Verify Payment</h2>
            <div class="form-group">
                <label for="razorpayOrderId">Razorpay Order ID:</label>
                <input type="text" id="razorpayOrderId" placeholder="order_xxx">
            </div>
            <div class="form-group">
                <label for="razorpayPaymentId">Razorpay Payment ID:</label>
                <input type="text" id="razorpayPaymentId" placeholder="pay_xxx">
            </div>
            <div class="form-group">
                <label for="razorpaySignature">Razorpay Signature:</label>
                <input type="text" id="razorpaySignature" placeholder="signature">
            </div>
            <div class="form-group">
                <label for="verifyApplicationId">Application ID:</label>
                <input type="text" id="verifyApplicationId" placeholder="application-uuid">
            </div>
            <button onclick="verifyPayment()">Verify Payment</button>
            <div id="verifyResponse" class="response" style="display: none;"></div>
        </div>

        <!-- Get Application Payments -->
        <div class="section">
            <h2>üìä Get Application Payments</h2>
            <div class="form-group">
                <label for="getPaymentsApplicationId">Application ID:</label>
                <input type="text" id="getPaymentsApplicationId" placeholder="application-uuid">
            </div>
            <button onclick="getApplicationPayments()">Get Payments</button>
            <div id="getPaymentsResponse" class="response" style="display: none;"></div>
        </div>

        <!-- Release Payout (Admin Only) -->
        <div class="section">
            <h2>üí∏ Release Payout (Admin Only)</h2>
            <div class="form-group">
                <label for="releaseApplicationId">Application ID:</label>
                <input type="text" id="releaseApplicationId" placeholder="application-uuid">
            </div>
            <button onclick="releasePayout()">Release Payout</button>
            <div id="releaseResponse" class="response" style="display: none;"></div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken') || '';
        if (authToken) {
            document.getElementById('tokenValue').textContent = authToken.substring(0, 50) + '...';
            document.getElementById('authStatus').textContent = 'Authenticated';
            document.getElementById('authStatus').className = 'status-badge authenticated';
        }

        function getBaseUrl() {
            return document.getElementById('baseUrl').value.trim();
        }

        async function testConnection() {
            const baseUrl = getBaseUrl();
            const url = `${baseUrl}/payments/config`;
            
            const responseEl = document.getElementById('connectionTestResponse');
            responseEl.style.display = 'block';
            responseEl.className = 'response';
            responseEl.innerHTML = '<pre>Testing connection...</pre>';
            
            console.log('Testing connection to:', url);
            
            try {
                const result = await makeRequest(url, 'GET');
                
                if (result.status === 200 || result.status === 401 || result.status === 403) {
                    // 401/403 means server is reachable but needs auth
                    showResponse('connectionTestResponse', {
                        success: true,
                        message: 'Connection successful! Server is reachable.',
                        status: result.status,
                        note: result.status === 401 || result.status === 403 
                            ? 'Authentication required (this is expected)' 
                            : 'Server responded successfully'
                    });
                } else if (result.status === 0) {
                    showResponse('connectionTestResponse', result.data, true);
                } else {
                    showResponse('connectionTestResponse', {
                        message: `Server responded with status ${result.status}`,
                        data: result.data
                    }, result.status >= 400);
                }
            } catch (error) {
                showResponse('connectionTestResponse', {
                    error: 'Connection test failed',
                    message: error.message
                }, true);
            }
        }

        function getToken() {
            return authToken;
        }

        function setToken(token) {
            authToken = token;
            localStorage.setItem('authToken', token);
            document.getElementById('tokenValue').textContent = token.substring(0, 50) + '...';
            document.getElementById('authStatus').textContent = 'Authenticated';
            document.getElementById('authStatus').className = 'status-badge authenticated';
        }

        function showResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `response ${isError ? 'error' : 'success'}`;
            element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }

        async function makeRequest(url, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                },
                mode: 'cors'
            };

            const token = getToken();
            if (token) {
                options.headers['Authorization'] = `Bearer ${token}`;
            }

            if (body) {
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(url, options);
                
                // Try to parse JSON, but handle non-JSON responses
                let data;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    data = { message: text || `HTTP ${response.status} ${response.statusText}` };
                }
                
                return { status: response.status, data };
            } catch (error) {
                // Enhanced error handling
                let errorMessage = error.message;
                const isFileProtocol = window.location.protocol === 'file:';
                
                if (error.message === 'Failed to fetch') {
                    if (isFileProtocol) {
                        errorMessage = `CORS Error: This HTML file is opened directly (file://). 
Please serve it through a local web server:
‚Ä¢ Python: python -m http.server 8000 (then open http://localhost:8000/payment-test.html)
‚Ä¢ Node: npx http-server -p 8000
‚Ä¢ VS Code: Use Live Server extension

Alternatively, check:
1. Is the server running at ${url}?
2. Is the URL correct?
3. Are there any browser console errors?`;
                    } else {
                        errorMessage = `Network error: Could not connect to ${url}. Check if:
1. The server is running
2. The URL is correct  
3. CORS is enabled on the server
4. You're not blocking the request
5. Check browser console for more details`;
                    }
                }
                return { 
                    status: 0, 
                    data: { 
                        error: errorMessage,
                        details: `URL: ${url}`,
                        protocol: window.location.protocol,
                        type: error.name || 'NetworkError'
                    } 
                };
            }
        }

        async function sendOTP() {
            const baseUrl = getBaseUrl();
            const phone = document.getElementById('phoneNumber').value.trim();
            const role = document.getElementById('userRole').value;

            if (!phone) {
                showResponse('sendOTPResponse', { error: 'Please enter phone number' }, true);
                return;
            }

            if (!phone.startsWith('+')) {
                showResponse('sendOTPResponse', { error: 'Phone number must start with + and include country code' }, true);
                return;
            }

            const body = { phone };
            if (role) {
                body.role = role;
            }

            const url = `${baseUrl}/auth/send-otp`;
            
            // Show loading state
            const responseEl = document.getElementById('sendOTPResponse');
            responseEl.style.display = 'block';
            responseEl.className = 'response';
            responseEl.innerHTML = '<pre>Sending OTP...</pre>';
            
            console.log('Sending OTP request to:', url, body);
            
            const result = await makeRequest(url, 'POST', body);
            
            console.log('OTP Response:', result);

            if (result.status === 200) {
                showResponse('sendOTPResponse', result.data);
            } else {
                showResponse('sendOTPResponse', result.data, true);
            }
        }

        async function verifyOTP() {
            const baseUrl = getBaseUrl();
            const phone = document.getElementById('phoneNumber').value.trim();
            const token = document.getElementById('otpToken').value.trim();

            if (!phone || !token) {
                showResponse('verifyOTPResponse', { error: 'Please enter phone number and OTP token' }, true);
                return;
            }

            const url = `${baseUrl}/auth/verify-otp`;
            const result = await makeRequest(url, 'POST', { phone, token });

            if (result.status === 200 && result.data.token) {
                setToken(result.data.token);
                showResponse('verifyOTPResponse', result.data);
            } else {
                showResponse('verifyOTPResponse', result.data, true);
            }
        }

        async function getPaymentConfig() {
            const baseUrl = getBaseUrl();
            const url = `${baseUrl}/payments/config`;
            const result = await makeRequest(url, 'GET');
            showResponse('configResponse', result.data, result.status !== 200);
        }

        async function createPaymentOrder() {
            const baseUrl = getBaseUrl();
            const applicationId = document.getElementById('applicationId').value;

            if (!applicationId) {
                showResponse('createOrderResponse', { error: 'Please enter Application ID' }, true);
                return;
            }

            const url = `${baseUrl}/payments/applications/${applicationId}`;
            const result = await makeRequest(url, 'POST');
            showResponse('createOrderResponse', result.data, result.status !== 201);
        }

        async function verifyPayment() {
            const baseUrl = getBaseUrl();
            const razorpayOrderId = document.getElementById('razorpayOrderId').value;
            const razorpayPaymentId = document.getElementById('razorpayPaymentId').value;
            const razorpaySignature = document.getElementById('razorpaySignature').value;
            const applicationId = document.getElementById('verifyApplicationId').value;

            if (!razorpayOrderId || !razorpayPaymentId || !razorpaySignature || !applicationId) {
                showResponse('verifyResponse', { error: 'Please fill all fields' }, true);
                return;
            }

            const url = `${baseUrl}/payments/verify`;
            const body = {
                razorpay_order_id: razorpayOrderId,
                razorpay_payment_id: razorpayPaymentId,
                razorpay_signature: razorpaySignature,
                application_id: applicationId
            };

            const result = await makeRequest(url, 'POST', body);
            showResponse('verifyResponse', result.data, result.status !== 200);
        }

        async function getApplicationPayments() {
            const baseUrl = getBaseUrl();
            const applicationId = document.getElementById('getPaymentsApplicationId').value;

            if (!applicationId) {
                showResponse('getPaymentsResponse', { error: 'Please enter Application ID' }, true);
                return;
            }

            const url = `${baseUrl}/payments/applications/${applicationId}`;
            const result = await makeRequest(url, 'GET');
            showResponse('getPaymentsResponse', result.data, result.status !== 200);
        }

        async function releasePayout() {
            const baseUrl = getBaseUrl();
            const applicationId = document.getElementById('releaseApplicationId').value;

            if (!applicationId) {
                showResponse('releaseResponse', { error: 'Please enter Application ID' }, true);
                return;
            }

            const url = `${baseUrl}/payments/applications/${applicationId}/release`;
            const result = await makeRequest(url, 'POST');
            showResponse('releaseResponse', result.data, result.status !== 200);
        }
    </script>
</body>
</html>

